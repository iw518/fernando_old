{% extends "project_home.html" %}
{% block css %}
{{super()}}
{% endblock %}
{% block nav %}
{{super()}}
{% endblock %}
{% block main %}
<div class="btn-toolbar" role="toolbar">
    <div class="btn-group">
        <button type="button" class="btn btn-primary" id='calculate' disabled="disabled"><span class="fa fa-calculator"></span>&nbsp;&nbsp;计算</button>
        <!--<input type=button id='calculate' value='计算单桩承载力' disabled="true">-->
        <button type="button" class="btn btn-primary" id='print'><span class="glyphicon glyphicon-print"></span>&nbsp;&nbsp;打印</button>
        <button type="button" class="btn btn-primary" id='del_tr'><span class="fa fa-trash-o fa-lg"></span>&nbsp;&nbsp;删除</button>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-primary" id='setting_btn'><span class="glyphicon glyphicon-cog"></span>&nbsp;&nbsp;设置</button>
    </div>
</div>
    <!--<div class="input-group margin-bottom-sm">
        <span class="input-group-addon"><i class="fa fa-trash-o fa-lg"></i></span>
        <input class="form-control" type="text" name="del_index" placeholder="删除某一行计算结果">
    </div>-->
<form class="form-horizontal" role="form">
    <div class="form-group">
        <label class="col-sm-1 control-label">计算孔号</label>
        <div class="col-sm-1">
            <select class="form-control" id="holes" onChange="showLayer()">
                {% for xHole in holelist %}
                <option>{{xHole.holeName}}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</form>

<div style="position:relative;">
    <div id="setting_div" class="bg-primary" style="position:absolute;">
        <div class="radio">
            <label>
                <input type="radio" name="optionsRadios" id="optionsRadios1" value="option1" checked>
                6m以上fs取值15kPa
            </label>
        </div>
        <div class="radio">
            <label>
                <input type="radio" name="optionsRadios" id="optionsRadios2" value="option2">
                4m以上fs取值15kPa
            </label>
        </div>

        <table class='hor-calculate'>
            <thead>
                <tr>
                    <th width="5%" rowspan="2">序号</th>
                    <th width="10%" rowspan="2">土层编号</th>
                    <th width="25%" rowspan="2">土层名称</th>
                    <th width="10%" rowspan="2">比贯入阻力Ps(MPa)</th>
                    <th width="20%" style="border-bottom: 1px solid #6678b1;" colspan="2">预制桩桩基参数</th>
                    <th width="20%" style="border-bottom: 1px solid #6678b1;" colspan="2">灌注桩桩基参数</th>
                    <th width="10%" rowspan="2">抗拔系数&lambda;</th>
                </tr>
                <tr>
                    <th>fs(MPa)</th>
                    <th>fp(MPa)</th>
                    <th>fs(MPa)</th>
                    <th>fp(MPa)</th>
                </tr>
            </thead>
            <tbody>
            {%for xLayer in layerlist %}
                <tr  class="layer_tr">
                    <td>{{loop.index}}</td>
                    <td>{{xLayer.layerNo}}</td>
                    <td>{{xLayer.layerName}}</td>
                    <td>{{xLayer.AVG_Ps}}</td>
                    <td class="fs"><input></td>
                    <td class="fp"><input></td>
                    <td class="fs"><input></td>
                    <td class="fp"><input></td>
                    <td class="mylambda"><input></td>
                </tr>
            {%endfor%}
            </tbody>
        </table>
    </div>
</div>


<div id="printArea">
<table  id="result_table" class="hor-calculate">
    <thead>
    <tr>
        <th colspan="15" style="text-align: center;">
            <p>桩基计算书</p>
            <p />
            <p style="text-align: left; border-bottom: 1px solid #6678b1;">工程编号：{{projectNo}}</p>
        </th>
    </tr>
        <tr>
            <th width="7%">计算孔号</th>
            <th width="10%">桩型</th>
            <th width="7%">方桩边长<br />管桩壁厚<br />(mm)</th>
            <th width="5%">圆桩<br />直径<br />(mm)</th>
            <th width="5%">桩长<br />(m)</th>
            <th width="5%">桩顶<br />埋深<br />(m)</th>
            <th width="5%">桩底<br />埋深<br />(m)</th>
            <th width="6%">桩顶<br />标高<br />(m)</th>
            <th width="6%">桩底<br />标高<br />(m)</th>
            <th width="8%">桩侧总极限<br />摩阻力<br />标准值<br />Rsk(kN)</th>
            <th width="7%">桩端极限<br />摩阻力<br />标准值<br />Rpk(kN)</th>
            <th width="7%">单桩极限<br />承载力<br />标准值<br />Rk(kN)</th>
            <th width="7%">单桩竖向<br />承载力<br />设计值<br />Rd(kN)</th>
            <th width="7%">单桩竖向<br />承载力<br />特征值<br />Ra(kN)</th>
            <th width="8%">单桩竖向<br />抗拔承载力<br />设计值<br />Rtd(kN)</th>
        </tr>
    </thead>
    <tbody>
        <tr class="result_tr">
            <td class="selected_hole"></td>
            <td>
                <select  class='piletype_select' size=1 style='margin:-2;' ondblclick='gen_tr(this)'></select>
            </td>
            <td><input name="side_or_thickness"></td>
            <td><input name="diameter"></td>
            <td><input name="pile_length"></td>
            <td><input name="top_depth"></td>
            <td class="bottom_depth"></td>
            <td class="top_level"></td>
            <td class="bottom_level"></td>
            <td class="Rsk"></td>
            <td class="Rpk"></td>
            <td class="Rk"></td>
            <td class="Rd"></td>
            <td class="Ra"></td>
            <td class="Rtd"></td>
        </tr>
    </tbody>
</table>

<table id='layertable'  class='hor-calculate'>
    <thead>
        <tr>
            <th  width="5%" rowspan="2">序号</th>
            <th  width="10%" rowspan="2">土层编号</th>
            <th  width="20%" rowspan="2">土层名称</th>
            <th  width="15%" rowspan="2">分层深度(m)</th>
            <th  width="20%" style="border-bottom: 1px solid #6678b1;" colspan="2">预制桩桩基参数</th>
            <th  width="20%" style="border-bottom: 1px solid #6678b1;" colspan="2">灌注桩桩基参数</th>
            <th  width="10%" rowspan="2">抗拔系数&lambda;</th>
        </tr>
        <tr>
            <th>fs(MPa)</th>
            <th>fp(MPa)</th>
            <th>fs(MPa)</th>
            <th>fp(MPa)</th>
        </tr>
    </thead>
    <tbody>
        <tr class="layer_tr">
            <td class='No'></td>
            <td class='layerNo'></td>
            <td class='layerName'></td>
            <td class='endDep'></td>
            <td class='fs'><input></td>
            <td class='fp'><input></td>
            <td class='fs'><input></td>
            <td class='fp'><input></td>
            <td class='mylambda'><input></td>
        </tr>
    </tbody>
</table>
</div>
{% endblock %}

{% block script%}
    {{super()}}


<script>
//设置全局桩基参数
$(function(){
    $('#setting_div').css('left','100%');
    var expanded = true;
    $('#setting_btn').click(function(){
    	if (expanded) {
    		$('#setting_div').animate({left:'0'},1000);
    	}else {
    		$('#setting_div').animate({left:'-100%'},1000);
    	}
    	expanded = !expanded;
    });
});
</script>

<script>
function showLayer(){
    $("#layertable tr[class='layer_tr']:gt(0)").remove();
    var selected_hole=$("#holes").find("option:selected").text();
    var dividing_line=6.00;
    {% for xHole in holelist %}
        if ("{{xHole.holeName}}"==selected_hole){
            var i=1;
            {% for xLayer in xHole.layers %}
                if((dividing_line-"{{xLayer.startDep}}")*(dividing_line-"{{xLayer.endDep}}")<0){
                    $("#layertable tr[class='layer_tr']:last").find("td[class='No']").text(i);
                    $("#layertable tr[class='layer_tr']:last").find("td[class='layerNo']").text("{{xLayer.layerNo}}");
                    $("#layertable tr[class='layer_tr']:last").find("td[class='layerName']").text("{{xLayer.layerName}}");
                    $("#layertable tr[class='layer_tr']:last").find("td[class='endDep']").text(dividing_line.toFixed(2));
                    $("#layertable").append($("#layertable tr[class='layer_tr']:last").clone());
                    i=i+1;
                }
                $("#layertable tr[class='layer_tr']:last").find("td[class='No']").text(i);
                $("#layertable tr[class='layer_tr']:last").find("td[class='layerNo']").text("{{xLayer.layerNo}}");
                $("#layertable tr[class='layer_tr']:last").find("td[class='layerName']").text("{{xLayer.layerName}}");
                $("#layertable tr[class='layer_tr']:last").find("td[class='endDep']").text("{{'%.2f'%(xLayer.endDep)}}");
                $("#layertable").append($("#layertable tr[class='layer_tr']:last").clone());
                i=i+1;
            {% endfor %}
            $("#layertable tr[class='layer_tr']:last").remove();
        }
    {% endfor %}
    //var layertable=document.getElementById("layertable").getElementsByTagName("tbody")[0];
    //document.getElementById("calculate").disabled=false;
    $('#calculate').attr("disabled",false);
}

function gen_tr(obj){
    var piletype_list=["预制方桩","PHC管桩","钻孔灌注桩","闭口钢管桩","抗拔预制方桩","抗拔钻孔灌注桩"];

    if (obj.options.length==0){
        $("#result_table").append($("#result_table tr[class='result_tr']:last").clone(true));
        for (var i=0;i<piletype_list.length;i++){
            var pile_option=new Option(piletype_list[i],i);
            obj.options.add(pile_option);
        }
    }
}
</script>

<script>
$(function() {
    var buildData=function(){
        var ret={};
        $("#layertable tbody:first>tr").each(function(index,item){
            var id=$(item).find("td").eq(0).text();
            var myArray=new Array($(item).find("td").eq(3).text(),
                                  $(item).find("td").eq(4).find("input").val(),
                                  $(item).find("td").eq(5).find("input").val(),
                                  $(item).find("td").eq(6).find("input").val(),
                                  $(item).find("td").eq(7).find("input").val(),
                                  $(item).find("td").eq(8).find("input").val()
                                  );
            ret[id]=myArray;
        });
        console.log(ret);
        return ret;
    }
    var calcu_pile=function(top_depth,pile_length,data,offset){
        var rsk=0;
        var rpk=0;
        var rs_top=0;
        var rs_bottom=0;
        for (i in data){
            if (i==1){rs_top=data[i][0]*data[i][offset+1];}
            else if (data[i][0]<top_depth){rs_top=rs_top+(data[i][0]-data[i-1][0])*data[i][offset+1];}
            else {
                rs_top=rs_top+(top_depth-data[i-1][0])*data[i][offset+1];
                break;}
        }

        for (i in data){
            if (i==1){rs_bottom=data[i][0]*data[i][offset+1];}
            else if (data[i][0]<(top_depth+pile_length)){rs_bottom=rs_bottom+(data[i][0]-data[i-1][0])*data[i][offset+1];}
            else {
                rs_bottom=rs_bottom+((top_depth+pile_length)-data[i-1][0])*data[i][offset+1];
                rsk=rs_bottom-rs_top;
                rpk=data[i][offset+2];
                break;}
        }
        return new Array(rsk,rpk);
    }

    var calcu_pile2=function(top_depth,pile_length,data,offset){
        var rt=0;
        var rs_top=0;
        var rs_bottom=0;
        for (i in data){
            if (i==1){rs_top=data[i][0]*data[i][offset+1]*data[i][5];}
            else if (data[i][0]<top_depth){rs_top=rs_top+(data[i][0]-data[i-1][0])*data[i][offset+1]*data[i][5];}
            else {
                rs_top=rs_top+(top_depth-data[i-1][0])*data[i][offset+1]*data[i][5];
                break;}
        }

        for (i in data){
            if (i==1){rs_bottom=data[i][0]*data[i][offset+1]*data[i][5];}
            else if (data[i][0]<(top_depth+pile_length)){rs_bottom=rs_bottom+(data[i][0]-data[i-1][0])*data[i][offset+1]*data[i][5];}
            else {
                rs_bottom=rs_bottom+((top_depth+pile_length)-data[i-1][0])*data[i][offset+1]*data[i][5];
                rt=rs_bottom-rs_top;
                break;}
        }
        return rt;
    }



    var show_result_tr=function(obj){
        //console.log(buildData());
        //var myselect=document.getElementById("holes");
        //var selectHole=myselect.options[myselect.selectedIndex].text;
        var selected_hole=$("#holes").find("option:selected").text();
        var pile_type=$(obj).find(".piletype_select:first").find("option:selected").text();
        var side_or_thickness=Number($(obj).find("input[name='side_or_thickness']:first").val());
        var diameter=Number($(obj).find("input[name='diameter']:first").val());
        var pile_length=Number($(obj).find("input[name='pile_length']:first").val());
        var top_depth=Number($(obj).find("input[name='top_depth']:first").val());
        var bottom_depth=top_depth+pile_length;

        var hole_level=0;
        {% for xHole in holelist %}
            if ("{{xHole.holeName}}"==selected_hole){
                hole_level={{xHole.elevation}};}
        {% endfor %}

        var top_level=hole_level-top_depth;
        var bottom_level=top_level-pile_length;

        var data=buildData();
        var perimeter=0;
        var area=0;
        var Rsk=0;
        var Rpk=0;
        var Rk=0;
        var Rd=0;
        var Ra=0;
        var Rtd=0;
        var offset=0;
        var Gp=0;

        switch (pile_type){
            case "预制方桩":
                offset=0;
                perimeter=side_or_thickness*4*0.001;
                area=side_or_thickness*side_or_thickness*0.001*0.001;
                break;
            case "PHC管桩":
                offset=0;
                perimeter=diameter*Math.PI*0.001;
                area=diameter*diameter*Math.PI*0.25*0.001*0.001;
                break;
            case "钻孔灌注桩":
                offset=2;
                perimeter=diameter*Math.PI*0.001;
                area=diameter*diameter*Math.PI*0.25*0.001*0.001;
                break;
            case "闭口钢管桩":
                offset=0;
                perimeter=diameter*Math.PI*0.001;
                area=diameter*diameter*Math.PI*0.25*0.001*0.001;
                break;
            case "抗拔预制方桩":
                offset=0;
                perimeter=side_or_thickness*4*0.001;
                area=side_or_thickness*side_or_thickness*0.001*0.001;
                break;
            case "抗拔钻孔灌注桩":
                offset=2;
                perimeter=diameter*Math.PI*0.001;
                area=diameter*diameter*Math.PI*0.25*0.001*0.001;
                break;
        }
        Rsk=calcu_pile(top_depth,pile_length,data,offset)[0]*perimeter;
        Rpk=calcu_pile(top_depth,pile_length,data,offset)[1]*area;
        Rk=Rsk+Rpk;
        var Pp=Rpk/Rk;
        var rs=2;
        var rp=2;
        var rs_arr=[2.09,2.16,2.18,2.13,2.03,1.88,1.73];
        var rp_arr=[1.08,1.20,1.37,1.61,1.93,2.34,2.83];
        var n=Math.floor(Pp/0.05)-1;
        if (n<=0){
            n=0;
            rs=rs_arr[n];
            rp=rp_arr[n];
        }
        else if (n>=6){
            n=6;
            rs=rs_arr[n];
            rp=rp_arr[n];
        }
        else{
            rs=(Pp-(n+1)*0.05)/0.05*(rs_arr[n+1]-rs_arr[n])+rs_arr[n];
            rp=(Pp-(n+1)*0.05)/0.05*(rp_arr[n+1]-rp_arr[n])+rp_arr[n];
        }
        Rd=Rsk/rs+Rpk/rp;
        Ra=Rk/2.0;
        Gp=area*pile_length*(25-10);
        Rtd=calcu_pile2(top_depth,pile_length,data,offset)*perimeter/2.0+Gp;
        $(obj).find("td.selected_hole:first").text(selected_hole);
        $(obj).find("td.bottom_depth:first").text(bottom_depth);
        $(obj).find("td.top_level:first").text(top_level.toFixed(1));
        $(obj).find("td.bottom_level:first").text(bottom_level.toFixed(1));
        if (pile_type.match("抗拔")){
            $(obj).find(".Rtd:first").text(Rtd.toFixed(1));
        }
        else{
            $(obj).find(".Rsk:first").text(Rsk.toFixed(1));
            $(obj).find(".Rpk:first").text(Rpk.toFixed(1));
            $(obj).find(".Rk:first").text(Rk.toFixed(1));
            $(obj).find(".Rd:first").text(Rd.toFixed(1));
            $(obj).find(".Ra:first").text(Ra.toFixed(1));
        }
    }


    //删除某一行计算结果，注意remove和empty的区别,empty仅删除，但不会将其从dom中移除
    $('#del_tr').bind('click', function() {
        var index=Number($("input[name='del_index']:first").val());
        $("#result_table tbody>tr").eq(index-1).remove();
    });


    $('#calculate').bind('click', function() {
        $("#result_table tbody>tr").each(function(index,item){
            if($(item).find(".piletype_select:first>option").length>0){
                show_result_tr($("#result_table tbody>tr").eq(index));
            }
        });
    return false;
    });
});
</script>
{%endblock%}